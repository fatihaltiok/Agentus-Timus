name: CI Gates

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gates:
    name: Quality Gates (Python 3.11)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      OPENAI_API_KEY: ci-dummy-openai-key
      ANTHROPIC_API_KEY: ci-dummy-anthropic-key
      VISION_MODEL: moondream-local
      REQUIRE_INCEPTION: "0"
      TIMUS_LIVE_STATUS: "false"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements-ci.txt

      - name: Install CI dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt

      - name: Gate 1 - Syntax Compile
        run: |
          python -m py_compile \
            main_dispatcher.py \
            agent/base_agent.py \
            agent/providers.py \
            memory/memory_system.py \
            memory/reflection_engine.py \
            server/mcp_server.py \
            utils/embedding_provider.py \
            verify_milestone6.py

      - name: Gate 2 - Regression Tests
        run: |
          pytest -q tests/test_milestone5_quality_gates.py tests/test_milestone6_e2e_readiness.py

      - name: Gate 3 - Milestone Readiness
        run: |
          python verify_milestone6.py
